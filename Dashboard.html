<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMEON | Orbital Ground Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
        }

        body {
            background: #050505;
            color: #e2e8f0;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        .cyber-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .glitch-hover:hover {
            box-shadow: 0 0 15px var(--neon-blue);
            border-color: var(--neon-blue);
        }

        .node-active {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px rgba(0, 242, 255, 0.2); }
            50% { box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }
            100% { box-shadow: 0 0 5px rgba(0, 242, 255, 0.2); }
        }

        .terminal-text { font-family: 'Fira Code', monospace; font-size: 11px; }

        .progress-bar {
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Background Decor -->
    <div class="fixed inset-0 pointer-events-none opacity-20">
        <div class="absolute top-0 left-0 w-full h-full" style="background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 40px 40px;"></div>
    </div>

    <div class="max-w-7xl mx-auto relative">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center gap-6">
                <div class="relative">
                    <div class="absolute -inset-1 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-full blur opacity-75 animate-pulse"></div>
                    <div class="relative bg-black p-4 rounded-full border border-white/10">
                        <i data-lucide="shield-half" class="w-8 h-8 text-cyan-400"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-4xl font-bold tracking-tighter uppercase italic">COSMEON <span class="text-cyan-400">FS</span></h1>
                    <div class="flex gap-4 mt-1">
                        <span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Mesh Network v2.0</span>
                        <span id="meshHealth" class="text-[10px] uppercase tracking-widest text-cyan-500 font-bold">Health: 100%</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <div class="cyber-panel px-6 py-3 rounded-2xl flex flex-col items-end">
                    <span class="text-[9px] uppercase text-slate-500 font-bold">System Latency</span>
                    <span class="text-xl font-bold text-cyan-400">12ms</span>
                </div>
                <div class="cyber-panel px-6 py-3 rounded-2xl flex flex-col items-end">
                    <span class="text-[9px] uppercase text-slate-500 font-bold">Bandwidth</span>
                    <span class="text-xl font-bold text-purple-400">Gbps 4.2</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left: Operations -->
            <div class="lg:col-span-1 space-y-6">
                <div class="cyber-panel p-6 rounded-3xl glitch-hover transition-all">
                    <h2 class="text-xs font-bold uppercase mb-6 text-slate-400 flex justify-between">
                        Ingress Station <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                    </h2>
                    <input type="file" id="fileUpload" class="hidden" onchange="uploadFile()">
                    <button onclick="document.getElementById('fileUpload').click()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-500 hover:to-blue-600 p-4 rounded-2xl font-bold text-sm tracking-widest uppercase transition-all shadow-lg shadow-cyan-900/20 active:scale-95">
                        Transmit Data
                    </button>
                    <div class="mt-6 space-y-4">
                        <div class="text-[10px] flex justify-between uppercase font-bold text-slate-500">
                            <span>Status</span><span class="text-cyan-400">Awaiting...</span>
                        </div>
                        <div class="progress-bar"><div id="uploadProgress" class="progress-fill" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="cyber-panel p-6 rounded-3xl h-[400px] flex flex-col">
                    <h2 class="text-xs font-bold uppercase mb-6 text-slate-400 flex justify-between">
                        Active Inventory <i data-lucide="box" class="w-4 h-4 text-purple-400"></i>
                    </h2>
                    <div id="fileList" class="space-y-3 overflow-y-auto flex-grow pr-2">
                        <!-- Files -->
                    </div>
                </div>
            </div>

            <!-- Right: The Orbital Grid -->
            <div class="lg:col-span-3 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="nodeGrid">
                    <!-- Nodes -->
                </div>

                <!-- Bottom: Terminal and Map -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 cyber-panel rounded-3xl overflow-hidden">
                        <div class="bg-white/5 px-6 py-3 border-b border-white/5 flex justify-between items-center">
                            <span class="text-[10px] font-bold uppercase tracking-widest">Ground Control Telemetry</span>
                            <div class="flex gap-2">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                        <div id="terminal" class="p-6 h-48 overflow-y-auto terminal-text text-slate-400 space-y-1">
                            <div>> SYSTEM INITIALIZED...</div>
                            <div>> LISTENING ON PORT 5000...</div>
                        </div>
                    </div>
                    
                    <div class="cyber-panel p-6 rounded-3xl flex flex-col justify-center items-center text-center">
                        <i data-lucide="fingerprint" class="w-12 h-12 text-cyan-500 mb-4 opacity-50"></i>
                        <h4 class="text-xs font-bold uppercase text-slate-400">Integrity Protocol</h4>
                        <p class="text-[9px] text-slate-500 mt-2">SHA-256 Validation active for all orbital handshakes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin; // Dynamically set based on where it's served
        const files = new Set();

        async function uploadFile() {
            const input = document.getElementById('fileUpload');
            if (!input.files[0]) return;
            
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            updateProgress(30);
            log(`UPLINK: Transmitting ${file.name}...`, 'text-cyan-400');

            try {
                const res = await fetch(`${API}/api/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.success) {
                    updateProgress(100);
                    log(`SUCCESS: Fragments signed and distributed. HASH: ${data.hash.substring(0,16)}...`, 'text-green-400');
                    files.add(file.name);
                    renderFiles();
                    sync();
                    setTimeout(() => updateProgress(0), 2000);
                }
            } catch (e) {
                log(`ERROR: Uplink failed. Check backend connection.`, 'text-red-500');
            }
        }

        async function sync() {
            try {
                const res = await fetch(`${API}/api/status`);
                const data = await res.json();
                document.getElementById('meshHealth').innerText = `Health: ${data.mesh_health}%`;
                renderNodes(data.node_status, data.node_contents);
                
                // Keep track of any uploaded files found on server
                Object.values(data.node_contents).flat().forEach(partName => {
                    const originalName = partName.split('.part_')[0];
                    if (originalName) files.add(originalName);
                });
                renderFiles();
            } catch (e) {}
        }

        function renderNodes(status, contents) {
            const grid = document.getElementById('nodeGrid');
            grid.innerHTML = Object.entries(status).map(([id, online]) => `
                <div onclick="toggleNode('${id}')" class="cyber-panel p-4 rounded-3xl cursor-pointer transition-all ${online ? 'node-active border-cyan-500/30' : 'opacity-30 grayscale'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-white/5 rounded-lg">
                            <i data-lucide="satellite" class="w-4 h-4 ${online ? 'text-cyan-400' : 'text-slate-500'}"></i>
                        </div>
                        <div class="w-2 h-2 rounded-full ${online ? 'bg-cyan-500 shadow-[0_0_8px_#00f2ff]' : 'bg-red-500'}"></div>
                    </div>
                    <h3 class="text-[10px] font-bold uppercase tracking-tighter text-slate-400">${id.replace('_', ' ')}</h3>
                    <div class="mt-4 terminal-text text-[9px] text-slate-500 truncate h-12">
                        ${contents[id].length ? contents[id].map(f => `<div>â€¢ ${f.substring(0,15)}</div>`).join('') : 'Empty'}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderFiles() {
            const list = document.getElementById('fileList');
            if (files.size === 0) {
                list.innerHTML = '<div class="text-[10px] text-slate-600 italic">No active telemetry...</div>';
                return;
            }
            list.innerHTML = Array.from(files).map(name => `
                <div class="bg-white/5 border border-white/5 p-4 rounded-2xl flex flex-col gap-3 group hover:border-cyan-500/50 transition-all">
                    <span class="text-xs font-bold truncate text-slate-300">${name}</span>
                    <button onclick="recall('${name}')" class="bg-white/5 hover:bg-cyan-600/20 py-2 rounded-xl text-[10px] uppercase font-bold tracking-widest transition-all">Stitch Data</button>
                </div>
            `).join('');
        }

        async function recall(name) {
            log(`RECALL: Validating fragment parity for ${name}...`, 'text-purple-400');
            const res = await fetch(`${API}/api/download/${name}`);
            if (res.ok) {
                log(`INTEGRITY: Hash verified. File reassembled.`, 'text-green-400');
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                const err = await res.json();
                log(`CRITICAL: Reconstruction failed. Incomplete orbital map: ${err.missing_nodes?.join(', ')}`, 'text-red-500 font-bold');
            }
        }

        async function toggleNode(id) {
            await fetch(`${API}/api/toggle_node/${id}`, { method: 'POST' });
            sync();
        }

        function log(msg, cls = '') {
            const t = document.getElementById('terminal');
            const d = document.createElement('div');
            d.className = cls;
            d.innerHTML = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            t.prepend(d);
        }

        function updateProgress(w) { document.getElementById('uploadProgress').style.width = w + '%'; }

        setInterval(sync, 3000);
        sync();
        lucide.createIcons();
    </script>
</body>
</html>