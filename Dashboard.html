<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>COSMEON FS-LITE | Ground Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen p-6">

  <div class="max-w-6xl mx-auto space-y-6">

    <!-- HEADER -->
    <header class="flex justify-between items-center border-b border-slate-800 pb-4">
      <div>
        <h1 class="text-3xl font-bold text-blue-400">COSMEON FS-LITE</h1>
        <p class="text-xs text-slate-500">Distributed Orbital File System</p>
      </div>
      <span id="status" class="text-xs px-3 py-1 rounded bg-red-600/20 text-red-400">BACKEND OFFLINE</span>
    </header>

    <!-- UPLOAD -->
    <section class="bg-slate-900 p-6 rounded-lg border border-slate-800">
      <h2 class="font-semibold mb-3">Upload & Shred</h2>
      <input type="file" id="fileInput" class="mb-3 text-sm" />
      <button onclick="uploadFile()" class="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded font-bold">
        SHRED & DISTRIBUTE
      </button>
      <p id="uploadLog" class="text-xs text-slate-400 mt-2"></p>
    </section>

    <!-- FILE LIST -->
    <section class="bg-slate-900 p-6 rounded-lg border border-slate-800">
      <h2 class="font-semibold mb-3">Distributed Files</h2>
      <table class="w-full text-sm">
        <thead class="text-slate-400">
          <tr>
            <th class="text-left py-2">File</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="fileTable"></tbody>
      </table>
    </section>

    <!-- LOG -->
    <section class="bg-black p-4 rounded border border-slate-800 text-xs h-40 overflow-y-auto" id="logBox">
      [SYSTEM] Ground Control Initialized
    </section>

  </div>

<script>
  const API_BASE = "http://127.0.0.1:8000"; // change after deployment
  const logBox = document.getElementById("logBox");

  function log(msg) {
    logBox.innerHTML += `<br>[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function checkStatus() {
    try {
      await fetch(`${API_BASE}/status`);
      document.getElementById("status").innerText = "BACKEND ONLINE";
      document.getElementById("status").className = "text-xs px-3 py-1 rounded bg-green-600/20 text-green-400";
    } catch {
      log("Backend unreachable");
    }
  }

  async function uploadFile() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) return;

    log(`Uploading ${file.name}`);
    const form = new FormData();
    form.append("file", file);

    const res = await fetch(`${API_BASE}/upload`, {
      method: "POST",
      body: form
    });

    if (res.ok) {
      log("File shredded and distributed across nodes");
      fetchFiles();
    } else {
      log("Upload failed");
    }
  }

  async function fetchFiles() {
    const res = await fetch(`${API_BASE}/files`);
    const files = await res.json();

    const table = document.getElementById("fileTable");
    table.innerHTML = "";

    files.forEach(f => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="py-2">${f.filename}</td>
        <td class="text-right space-x-2">
          <button onclick="downloadFile('${f.id}')" class="text-green-400">Download</button>
          <button onclick="deleteFile('${f.id}')" class="text-red-400">Delete</button>
        </td>
      `;
      table.appendChild(row);
    });
  }

  async function downloadFile(id) {
    log("Reassembling file...");
    const res = await fetch(`${API_BASE}/download/${id}`);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "recovered_file";
    a.click();
  }

  async function deleteFile(id) {
    await fetch(`${API_BASE}/delete/${id}`, { method: "DELETE" });
    log("File deleted");
    fetchFiles();
  }

  checkStatus();
  fetchFiles();
</script>

</body>
</html>
