<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Mesh Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Space+Mono&display=swap');
        
        body {
            background-color: #050505;
            color: #e0e0e0;
            font-family: 'Space Grotesk', sans-serif;
        }

        .mono { font-family: 'Space Mono', monospace; }

        .glass {
            background: rgba(20, 20, 25, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .node-active { color: #10b981; filter: drop-shadow(0 0 8px #10b981); }
        .node-inactive { color: #ef4444; filter: drop-shadow(0 0 8px #ef4444); }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-bold tracking-tighter text-white">SATELLITE <span class="text-blue-500">MESH</span></h1>
                <p class="text-gray-500 mono text-sm">Decentralized Storage Protocol v2.1</p>
            </div>
            <div class="glass p-4 rounded-xl flex items-center gap-6">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">Mesh Health</p>
                    <div class="flex items-center gap-2">
                        <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                            <div id="health-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <span id="health-text" class="mono text-blue-400">0%</span>
                    </div>
                </div>
                <div class="h-10 w-px bg-gray-800"></div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 uppercase font-bold">Uplink Status</p>
                    <p id="connection-status" class="text-yellow-500 mono animate-pulse">CONNECTING...</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Uplink Control -->
            <div class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        Transmit Data
                    </h2>
                    <input type="file" id="fileInput" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="w-full border-2 border-dashed border-gray-700 hover:border-blue-500 py-10 rounded-xl transition-all group">
                        <span class="text-gray-500 group-hover:text-blue-400 transition-colors">Select File for Fragmentation</span>
                    </button>
                    <button id="uploadBtn" onclick="uploadFile()" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        INITIATE UPLINK
                    </button>
                </div>

                <div class="glass p-6 rounded-2xl">
                    <h2 class="text-xl font-bold mb-4">System Console</h2>
                    <div id="console" class="h-48 overflow-y-auto font-mono text-xs space-y-1 text-gray-400 p-2 bg-black rounded-lg">
                        > Awaiting system start...
                    </div>
                </div>
            </div>

            <!-- Right: Node Map -->
            <div class="lg:col-span-2 glass p-6 rounded-3xl relative overflow-hidden">
                <h2 class="text-2xl font-bold mb-8">Orbital Node Status</h2>
                <div id="nodes-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Nodes injected here -->
                </div>
                
                <!-- Decorative background grid -->
                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 30px 30px;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5000/api";
        const log = (msg) => {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += `<div><span class="text-blue-500">></span> ${msg}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        async function fetchStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                
                document.getElementById('connection-status').innerText = "STABLE";
                document.getElementById('connection-status').className = "text-green-500 mono";
                
                document.getElementById('health-bar').style.width = `${data.mesh_health}%`;
                document.getElementById('health-text').innerText = `${Math.round(data.mesh_health)}%`;

                const container = document.getElementById('nodes-container');
                container.innerHTML = '';

                Object.keys(data.node_status).forEach(nodeId => {
                    const isActive = data.node_status[nodeId];
                    const location = data.node_locations[nodeId];
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-xl border transition-all cursor-pointer ${isActive ? 'bg-green-500/5 border-green-500/20' : 'bg-red-500/5 border-red-500/20'}`;
                    card.onclick = () => toggleNode(nodeId);
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-500 uppercase">${nodeId.replace('_', ' ')}</p>
                                <p class="font-bold text-sm">${location}</p>
                            </div>
                            <div class="${isActive ? 'node-active' : 'node-inactive'}">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                document.getElementById('connection-status').innerText = "OFFLINE";
                document.getElementById('connection-status').className = "text-red-500 mono";
                log("Error connecting to terminal backend...");
            }
        }

        async function toggleNode(nodeId) {
            await fetch(`${API_BASE}/toggle_node/${nodeId}`, {method: 'POST'});
            log(`Toggled status for ${nodeId}`);
            fetchStatus();
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return log("No file selected!");

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerText = "FRAGMENTING...";
            log(`Initiating fragmentation for: ${fileInput.files[0].name}`);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    log(`SUCCESS: File split across active nodes.`);
                    log(`Integrity Hash: ${result.integrity_hash.substring(0, 16)}...`);
                } else {
                    log(`FAILURE: ${result.error}`);
                }
            } catch (err) {
                log("Uplink failed. Check backend terminal.");
            } finally {
                btn.disabled = false;
                btn.innerText = "INITIATE UPLINK";
            }
        }

        setInterval(fetchStatus, 3000);
        fetchStatus();
        log("System initialized. Awaiting user commands.");
    </script>
</body>
</html>
